function setupLevel() {
  messageDiv.textContent = "";
  nextBtn.style.display = "none";
  levelText.textContent = `Level ${level}`;

  const emojiChoices = shuffle([...allEmojis]).slice(0, level);
  const targetEmoji = emojiChoices[0];
  targetEmojiDiv.textContent = targetEmoji;

  const totalEmojis = 10;
  const correctCount = Math.floor(Math.random() * (totalEmojis - level + 1)) + 1;

  let emojiList = Array(correctCount).fill(targetEmoji);

  // Sisa emoji untuk jenis lain
  const otherSlots = totalEmojis - correctCount;
  const otherEmojiTypes = emojiChoices.slice(1);

  let remaining = otherSlots;
  for (let i = 0; i < otherEmojiTypes.length; i++) {
    const count = i === otherEmojiTypes.length - 1
      ? remaining
      : Math.floor(Math.random() * (remaining + 1));
    emojiList.push(...Array(count).fill(otherEmojiTypes[i]));
    remaining -= count;
  }

  emojiList = shuffle(emojiList);

  emojiContainer.innerHTML = "";
  emojiList.forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    emojiContainer.appendChild(span);
  });

  const options = new Set();
  options.add(correctCount);
  while (options.size < 4) {
    const n = correctCount + Math.floor(Math.random() * 5) - 2;
    if (n > 0 && n <= 10) options.add(n);
  }

  choicesDiv.innerHTML = "";
  shuffle(Array.from(options)).forEach(num => {
    const btn = document.createElement("button");
    btn.className = "choice-btn";
    btn.textContent = num;
    btn.onclick = () => {
      if (num === correctCount) {
        messageDiv.textContent = "✅ Benar!";
        nextBtn.style.display = "inline-block";
      } else {
        messageDiv.textContent = "❌ Coba lagi!";
      }
    };
    choicesDiv.appendChild(btn);
  });
}
